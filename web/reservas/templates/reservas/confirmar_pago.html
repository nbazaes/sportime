{% extends "base.html" %}

{% block title %}Confirmar pago - Sportime{% endblock %}

{% block content %}
<form id="confirmarPagoForm" method="post" style="display:none;">
  {% csrf_token %}
</form>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("confirmarPagoForm");
    if (!form) return;

    // Disable the global form-confirm handler so only this detailed dialog shows
    window.SPORTIME_DISABLE_GLOBAL_CONFIRM = true;

    const resumen = [
      '<div style="text-align:left">',
      '<div><strong>Reserva:</strong> #{{ reserva.id }}</div>',
      '<div><strong>Cancha:</strong> {{ reserva.cancha|escapejs }}</div>',
      '<div><strong>Fecha:</strong> {{ reserva.fecha|date:"d/m/Y"|escapejs }}</div>',
      '<div><strong>Hora:</strong> {{ reserva.hora|time:"H:i"|escapejs }}</div>',
      '</div>',
    ].join('');

    {% if descuento_pending %}
    const precio_base = {{ descuento_pending.monto_base }};
    const precio_desc = {{ descuento_pending.monto_desc }};
    const porcentaje = {{ descuento_pending.porcentaje }};
    {% else %}
    const precio_base = 5000;
    const precio_desc = 5000;
    const porcentaje = null;
    {% endif %}

    const detallesPago = [];
    if (porcentaje) {
      detallesPago.push(`<p>Para completar la reserva, confirma el pago de <strong><s>$${precio_base}</s> $${precio_desc}</strong> (${porcentaje}% descuento aplicado).</p>`);
    } else {
      detallesPago.push(`<p>Para completar la reserva, confirma el pago de <strong>$${precio_desc}</strong>.</p>`);
    }
    detallesPago.push('<p>Al confirmar: aparecerá en Pagos y sumarás <strong>+15 puntos</strong>.</p>');

    Swal.fire({
      ...window.SPORTIME_SWAL_DEFAULTS,
      title: "Confirmar pago",
      html: detallesPago.join('') + resumen,
      icon: "question",
      showCancelButton: true,
      confirmButtonText: "Confirmar",
      cancelButtonText: "Cancelar",
    }).then((result) => {
      // Re-enable global confirmations after user makes a choice
      window.SPORTIME_DISABLE_GLOBAL_CONFIRM = false;
      if (result.isConfirmed) {
        form.submit();
      } else {
        window.location.href = "{% url 'reservas:lista' %}";
      }
    });
  });
</script>
{% endblock %}
